#!/bin/bash
# Startup script for Mystery Melody Machine
# Supports both standard Pi and Zynthian v4 hardware configurations

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="$SCRIPT_DIR/.venv"
CONFIG_FILE="$SCRIPT_DIR/{{ service_config_file | default('config.production.yaml') }}"
LOG_DIR="/var/log/mystery-melody"

# Function to log with timestamp
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

log "Starting Mystery Melody Machine..."
log "Hardware: {{ 'Zynthian v4' if is_zynthian_hardware else 'Standard Pi' }}"
log "Script directory: $SCRIPT_DIR"
log "Virtual environment: $VENV_DIR"
log "Config file: $CONFIG_FILE"

# Check if virtual environment exists
if [ ! -d "$VENV_DIR" ]; then
    log "ERROR: Virtual environment not found at $VENV_DIR"
    exit 1
fi

# Check if config file exists, fallback to default
if [ ! -f "$CONFIG_FILE" ]; then
    log "Config not found, using default config.yaml"
    CONFIG_FILE="$SCRIPT_DIR/config.yaml"
fi

if [ ! -f "$CONFIG_FILE" ]; then
    log "ERROR: No config file found"
    exit 1
fi

{% if is_zynthian_hardware %}
# Zynthian v4 Hardware Checks
log "Performing Zynthian hardware checks..."

# Check GPIO access
if [ ! -c /dev/gpiomem ]; then
    log "WARNING: /dev/gpiomem not accessible - hardware controls may not work"
fi

# Check user groups
if ! groups | grep -q gpio; then
    log "WARNING: User not in gpio group - hardware controls may not work"
fi

# Check for Zynthian MIDI interfaces
log "Checking for Zynthian MIDI interfaces..."
if command -v aconnect >/dev/null 2>&1; then
    aconnect -l | grep -E "(pisound|audiophonics|hifiberry|iqaudio|fe-pi)" && \
        log "✓ Zynthian MIDI hardware detected" || \
        log "⚠ No Zynthian MIDI hardware detected"
fi

{% endif %}

# Activate virtual environment
log "Activating virtual environment..."
source "$VENV_DIR/bin/activate"

# Verify Python packages
log "Checking Python dependencies..."
if ! python -c "import mido" 2>/dev/null; then
    log "ERROR: mido not available, installing dependencies..."
    pip install -r "$SCRIPT_DIR/requirements.txt"
fi

{% if is_zynthian_hardware %}
# Test Zynthian integration
if ! python -c "from src.zynthian_integration import create_zynthian_integration; print('✓ Zynthian integration available')" 2>/dev/null; then
    log "WARNING: Zynthian integration not working properly"
fi
{% endif %}

# Check MIDI devices
log "Checking MIDI devices..."
python -c "
import mido
inputs = mido.get_input_names()
outputs = mido.get_output_names()
print(f'Input ports: {inputs}')
print(f'Output ports: {outputs}')
" || log "WARNING: MIDI device check failed"

# Change to project directory
cd "$SCRIPT_DIR"

# Start the engine
log "Starting Mystery Melody Machine..."
log "Using config: $CONFIG_FILE"

exec python src/main.py --config "$CONFIG_FILE"
